import{W as e,a as t,_ as i,n as a,r as s,bk as n,aG as o,aH as r,ay as c,bl as h,q as m,A as p,B as l,bm as u,e as d}from"./shell-ceb66a5c.js";import{A as b}from"./types-ba081baa.js";import{s as v,x as y}from"./icon-04f6a077.js";const g=e(v);let f=class extends g{constructor(){super(...arguments),this.userId=null,this.isProgressToastFeatureActivated=!1,this.pubsub=new s(this),this.achievementNotificationSubscriptionController=new n(this),this.onAchievementNotificationRecieved=async e=>{if(e&&"achievements"===e.gameID)try{const e=await o({operation:r.AchievementUnlockedNotifications,variables:{maxImageWidth:50}}),t=[],i=e.data.identity?.redditor.trophyCase?.notifications;i?.forEach((e=>{if(t.push(e.id),"StreakExtendedNotification"===e.__typename)this.activateProgressToast({open:!0,notificationType:b.STREAK_EXTENDED,streakLength:e.length});else if("TrophyProgressedNotification"===e.__typename){const t=e.trophy;"AchievementImageTrophy"===t.__typename&&this.activateProgressToast({open:!0,notificationType:b.TROPHY_PROGRESSED,numberCompleted:t.progress?.done,total:t.progress?.total,progressUnit:t.progress?.unit,imgSrc:t.lockedImage.url})}else if("TrophyUnlockedNotification"===e.__typename){const t=e.trophy;"AchievementImageTrophy"!==t.__typename&&"AchievementRepeatableImageTrophy"!==t.__typename||this.activateProgressToast({open:!0,notificationType:b.TROPHY_UNLOCKED,message:t.name,imgSrc:t.image.url})}})),t&&t.length>0&&this.deleteAchievementNotifications(t)}catch(e){window.Sentry?.captureError?.(e)}},this._activateFeature=async e=>c(e)}async activateProgressToast(e){const t=!!document.querySelector("achievement-progress-toast");if(!this.isProgressToastFeatureActivated&&!t)try{this.isProgressToastFeatureActivated=!0,await this._activateFeature({name:h})}catch(e){this.isProgressToastFeatureActivated=!1}this.pubsub.publish(m.AchievementsProgressToast,e)}async connectedCallback(){super.connectedCallback(),this.subscribeToAchievementNotifications(),p.isAvailable()&&p.getItem(l.AchievementsStore)===`${this.userId}-${u.Enrolled}`||this.enrollUserIntoAchievements()}async deleteAchievementNotifications(e){try{await o({operation:r.DeleteAchievementNotifications,variables:{ids:e}})}catch(e){window.Sentry?.captureError?.(e)}}async enrollUserIntoAchievements(){try{const e=await o({operation:r.EnrollInStreaks,variables:{input:{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,gameId:"achievements"}}}),t=e.data?.enrollInGamification?.ok;if(!t)return;p.isAvailable()&&p.setItem(l.AchievementsStore,`${this.userId}-${e.data?.enrollInGamification?.status||""}`)}catch(e){window.Sentry?.captureError?.(e)}}subscribeToAchievementNotifications(){try{this.achievementNotificationSubscriptionController.subscribe({query:{operationName:"SubscribeSubscription",query:"\n            subscription SubscribeSubscription($input: SubscribeInput!) {\n              subscribe(input: $input) {\n                ... on BasicMessage {\n                  data {\n                    ... on GamificationAccomplishmentsMessageData {\n                      gameID\n                    }\n                  }\n                }\n              }\n            }\n            ",variables:{input:{channel:{teamOwner:"I18N",category:"GAMIFICATION",userID:this.userId}}}},onData:async e=>{this.onAchievementNotificationRecieved(e?.data?.subscribe.data)}})}catch(e){window.Sentry?.captureError?.(e)}}render(){return y``}};f.styles=[t],i([a({type:String,attribute:"user-id"})],f.prototype,"userId",void 0),f=i([d("achievement-events")],f);
//# sourceMappingURL=achievements-events-client-js-b2fe67a1.js.map
